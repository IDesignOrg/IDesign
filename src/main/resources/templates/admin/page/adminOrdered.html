<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 관리</title>
    <link rel="stylesheet" href="/css/adminPage.css" />
</head>

<body>
    <div th:insert="~{/admin/page/adminsidebar :: sidebar}"></div>
    <div class="main-content">
        <header>
            <h1>주문 관리</h1>
        </header>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>주문 번호</th>
                        <th>주문 번호(유니크)</th>
                        <th>주문 상태</th>
                        <th>배송 상태</th>
                        <th>주문 날짜</th>
                        <th>상품 번호</th>
                        <th>사용자 이름</th>
                        <th>수량</th>
                        <th>결제 UID</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="order : ${orders}" th:data-orderedno="${order.orderedNo}">
                        <td th:text="${order.orderedNo}"></td>
                        <td th:text="${order.orderedNumber}"></td>
                        <td th:text="${order.orderedState}"></td>
                        <td th:text="${order.shipmentState}"></td>
                        <td th:text="${#temporals.format(order.orderedDate, 'yyyy-MM-dd')}"></td>
                        <td th:text="${order.shopNo}"></td>
                        <td th:text="${order.userEntity.UName}"></td>
                        <td th:text="${order.quantity}"></td>
                        <td th:text="${order.merchantUId}"></td>
                        <td>
                            <input type="hidden" th:data-merchant-uid="${order.merchantUId}" />
                            <button class="refund-btn" th:data-orderedno="${order.orderedNo}">환불하기</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- JavaScript로 데이터 로드 및 환불 처리 -->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // 환불 버튼 이벤트 추가
                var refundButtons = document.querySelectorAll(".refund-btn");
                refundButtons.forEach(function (button) {
                    button.addEventListener("click", function () {
                        var merchantUId = button.previousElementSibling.getAttribute('data-merchant-uid');
                        if (confirm("해당 주문을 환불하시겠습니까?")) {
                            refundOrder(merchantUId);
                        }
                    });
                });

                function refundOrder(merchantUId) {
                    fetch('/refund/payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ merchantUId: merchantUId })
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('환불 처리가 완료되었습니다. 카드 승인 취소는 영업일 기준 최대 3-5일 소요됩니다. 취소 지연시, 해당 카드사로 문의하세요.');
                            location.reload(); // 페이지 새로고침으로 목록 갱신
                        } else {
                            alert('주문 환불에 실패했습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('Error refunding order:', error);
                        alert('주문 환불 중 오류가 발생했습니다.');
                    });
                }
            });
        </script>
    </div>
</body>

</html>
