<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>회원 정보</title>
	<link rel="stylesheet" href="/css/adminPage.css" />
</head>

<body>
	<div th:insert="~{/admin/page/adminsidebar :: sidebar}"></div>
	<div class="main-content">
		<header>
			<h1>회원 정보</h1>
		</header>
		<div class="table-container">
			<table>
				<thead>
					<tr>
						<th>이름</th>
						<th>닉네임</th>
						<th>EMail</th>
						<th>가입일</th>
						<th>게시물</th>
						<th>댓글</th>
						<th>삭제</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="userWithCounts : ${usersWithCounts}" th:data-uno="${userWithCounts.user.UNo}">
						<td th:text="${userWithCounts.user.UId}"></td>
						<td th:text="${userWithCounts.user.UName}"></td>
						<td th:text="${userWithCounts.user.UMail}"></td>
						<td th:text="${userWithCounts.user.URegister}"></td>
						<td class="post-count" th:data-post-count="${userWithCounts.postCount}"
							th:text="${userWithCounts.postCount}"></td>
						<td class="comment-count" th:data-comment-count="${userWithCounts.commentCount}"
							th:text="${userWithCounts.commentCount}"></td>
						<td><button class="delete-btn" th:data-uno="${userWithCounts.user.UNo}">삭제</button></td>
					</tr>
					<!-- 다른 데이터 행들 -->
				</tbody>
			</table>
		</div>

		<!-- JavaScript 모달 제어 및 데이터 로드 -->
		<script>
			document.addEventListener("DOMContentLoaded", function () {
				var postModal = document.getElementById("userModal");
				var commentModal = document.getElementById("commentModal");
				var span = document.getElementsByClassName("close");

				// 비활성화 버튼 이벤트 추가
				var deleteButtons = document.querySelectorAll(".delete-btn");
				deleteButtons.forEach(function (button) {
					button.addEventListener("click", function () {
						var userUNo = button.getAttribute("data-uno");
						if (confirm("해당 유저를 비활성화 하시겠습니까?")) {
							deactivateUser(userUNo);
						}
					});
				});

				function deactivateUser(userUNo) {
					fetch('/deactivateUser?userUNo=' + userUNo, {
						method: 'POST' // POST 요청으로 전송
					})
						.then(response => {
							if (response.ok) {
								alert('해당 유저는 비활성화 되었습니다.');
								location.reload(); // 페이지 새로고침으로 목록 갱신
							} else {
								alert('유저 비활성화에 실패했습니다.');
							}
						})
						.catch(error => {
							console.error('Error deactivating user:', error);
							alert('유저 비활성화 중 오류가 발생했습니다.');
						});
				}

				// 기존의 게시글 모달 이벤트 처리
				var postCountElements = document.querySelectorAll(".post-count");
				postCountElements.forEach(function (element) {
					element.addEventListener("click", function () {
						var postCount = parseInt(element.getAttribute("data-post-count"));
						var userUNo = element.parentElement.getAttribute("data-uno");

						if (postCount === 0) {
							document.getElementById("modalTableBody").innerHTML = '<tr><td colspan="6">아직 게시글을 작성하지 않았습니다</td></tr>';
							postModal.style.display = "block";
						} else {
							fetch('/fetchPosts?userUNo=' + userUNo)
								.then(response => response.json())
								.then(data => {
									if (!data || data.length === 0) {
										document.getElementById("modalTableBody").innerHTML = '<tr><td colspan="6">게시글이 없습니다.</td></tr>';
									} else {
										let tableRows = data.map(post => `
											<tr>
												<td>${post.RNo}</td>
												<td>${post.RTitle}</td>
												<td>${post.RStarRating}</td>
												<td>${post.RViews}</td>
												<td>${new Date(post.RWrittenTime).toLocaleString()}</td>
												<td><button class="delete-post-btn" data-rno="${post.RNo}">삭제</button></td>
											</tr>
										`).join('');
										document.getElementById("modalTableBody").innerHTML = tableRows;

										// 삭제 버튼에 클릭 이벤트 추가
										var deleteButtons = document.querySelectorAll(".delete-post-btn");
										deleteButtons.forEach(function (button) {
											button.addEventListener("click", function () {
												var rNo = button.getAttribute("data-rno");
												deletePost(rNo);
											});
										});
									}
									postModal.style.display = "block";
								})
								.catch(error => {
									console.error('Error fetching posts:', error);
									document.getElementById("modalTableBody").innerHTML = '<tr><td colspan="6">데이터를 가져오는 중 오류가 발생했습니다.</td></tr>';
									postModal.style.display = "block";
								});
						}
					});
				});

				var commentCountElements = document.querySelectorAll(".comment-count");
				commentCountElements.forEach(function (element) {
					element.addEventListener("click", function () {
						var commentCount = parseInt(element.getAttribute("data-comment-count"));
						var userUNo = element.parentElement.getAttribute("data-uno");

						if (commentCount === 0) {
							document.getElementById("commentModalTableBody").innerHTML = '<tr><td colspan="4">아직 댓글을 작성하지 않았습니다</td></tr>';
							commentModal.style.display = "block";
						} else {
							fetch('/fetchComments?userUNo=' + userUNo)
								.then(response => response.json())
								.then(data => {
									if (!data || data.length === 0) {
										document.getElementById("commentModalTableBody").innerHTML = '<tr><td colspan="4">댓글이 없습니다.</td></tr>';
									} else {
										let tableRows = data.map(comment => `
											<tr>
												<td>${comment.shopReviewNo}</td>
												<td>${comment.shopReviewContent}</td>
												<td>${new Date(comment.shopReviewCreated).toLocaleString()}</td>
												<td><button class="delete-comment-btn" data-shopReviewNo="${comment.shopReviewNo}">삭제</button></td>
											</tr>
										`).join('');
										document.getElementById("commentModalTableBody").innerHTML = tableRows;

										// 댓글 삭제 버튼에 클릭 이벤트 추가
										var deleteCommentButtons = document.querySelectorAll(".delete-comment-btn");
										deleteCommentButtons.forEach(function (button) {
											button.addEventListener("click", function () {
												var shopReviewNo = button.getAttribute("data-shopReviewNo");
												deleteComment(shopReviewNo);
											});
										});
									}
									commentModal.style.display = "block";
								})
								.catch(error => {
									console.error('Error fetching comments:', error);
									document.getElementById("commentModalTableBody").innerHTML = '<tr><td colspan="4">데이터를 가져오는 중 오류가 발생했습니다.</td></tr>';
									commentModal.style.display = "block";
								});
						}
					});
				});

				for (let i = 0; i < span.length; i++) {
					span[i].onclick = function () {
						postModal.style.display = "none";
						commentModal.style.display = "none";
					}
				}

				window.onclick = function (event) {
					if (event.target === postModal || event.target === commentModal) {
						postModal.style.display = "none";
						commentModal.style.display = "none";
					}
				}
			});

			// 게시글 삭제 요청 함수
			function deletePost(rNo) {
				fetch('/deletePost?rNo=' + rNo, {
					method: 'DELETE'
				})
					.then(response => {
						if (response.ok) {
							alert('게시글이 삭제되었습니다.');
							location.reload(); // 페이지 새로고침으로 목록 갱신
						} else {
							alert('게시글 삭제에 실패했습니다.');
						}
					})
					.catch(error => {
						console.error('Error deleting post:', error);
						alert('게시글 삭제 중 오류가 발생했습니다.');
					});
			}

			// 댓글 삭제 요청 함수
			function deleteComment(shopReviewNo) {
				fetch('/deleteComment?shopReviewNo=' + shopReviewNo, {
					method: 'DELETE'
				})
					.then(response => {
						if (response.ok) {
							alert('댓글이 삭제되었습니다.');
							location.reload(); // 페이지 새로고침으로 목록 갱신
						} else {
							alert('댓글 삭제에 실패했습니다.');
						}
					})
					.catch(error => {
						console.error('Error deleting comment:', error);
						alert('댓글 삭제 중 오류가 발생했습니다.');
					});
			}
		</script>
</body>

</html>
