<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>회원 정보</title>
	<link rel="stylesheet" href="/css/adminPage.css" />
</head>

<body>
	<div class="sidebar">
		<div class="logo">
			<h2>관리자 페이지</h2>
		</div>
		<ul>
			<li><a href="#">Account</a></li>
			<li><a href="#">Activity</a></li>
			<li><a href="#">Place</a></li>
		</ul>
	</div>
	<div class="main-content">
		<header>
			<h1>회원 정보</h1>
		</header>
		<div class="table-container">
			<table>
				<thead>
					<tr>
						<th>이름</th>
						<th>닉네임</th>
						<th>EMail</th>
						<th>가입일</th>
						<th>게시물</th>
						<th>댓글</th>
						<th>삭제</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="userWithCounts : ${usersWithCounts}" th:data-uno="${userWithCounts.user.UNo}">
						<td th:text="${userWithCounts.user.UId}"></td>
						<td th:text="${userWithCounts.user.UName}"></td>
						<td th:text="${userWithCounts.user.UMail}"></td>
						<td th:text="${userWithCounts.user.URegister}"></td>
						<td class="post-count" th:data-post-count="${userWithCounts.postCount}"
							th:text="${userWithCounts.postCount}"></td>
						<td class="comment-count" th:data-post-count="${userWithCounts.postCount}"
							th:data-comment-count="${userWithCounts.commentCount}"
							th:text="${userWithCounts.commentCount}"></td>
						<td><button class="delete-btn">삭제</button></td>
					</tr>
					<!-- 다른 데이터 행들 -->
				</tbody>
			</table>
		</div>
		<div id="userModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>회원 게시글</h2>
				<table id="modalTable">
					<thead>
						<tr>
							<th>번호</th>
							<th>제목</th>
							<th>별점</th>
							<th>조회수</th>
							<th>작성일</th>
						</tr>
					</thead>
					<tbody id="modalTableBody">
						<!-- JavaScript로 추가될 행들 -->
					</tbody>
				</table>
			</div>
		</div>

		<!-- JavaScript 모달 제어 및 데이터 로드 -->
		<script>
			document.addEventListener("DOMContentLoaded", function () {
				var modal = document.getElementById("userModal");
				var span = document.getElementsByClassName("close")[0];

				var postCountElements = document.querySelectorAll(".post-count");
				postCountElements.forEach(function (element) {
					element.addEventListener("click", function () {
						var postCount = parseInt(element.getAttribute("data-post-count"));
						var userUNo = element.parentElement.getAttribute("data-uno");

						if (postCount === 0) {
							document.getElementById("modalTableBody").innerHTML = '<tr><td colspan="6">아직 게시글을 작성하지 않았습니다</td></tr>';
							modal.style.display = "block";
						} else {
							fetch('/fetchPosts?userUNo=' + userUNo)
								.then(response => response.json())
								.then(data => {
									if (!data || data.length === 0) {
										document.getElementById("modalTableBody").innerHTML = '<tr><td colspan="6">게시글이 없습니다.</td></tr>';
									} else {
										let tableRows = data.map(post => `
                                <tr>
                                    <td>${post.RNo}</td>
                                    <td>${post.RTitle}</td>
                                    <td>${post.RStarRating}</td>
                                    <td>${post.RViews}</td>
                                    <td>${new Date(post.RWrittenTime).toLocaleString()}</td>
                                    <td><button class="delete-post-btn" data-rno="${post.RNo}">삭제</button></td>
                                </tr>
                            `).join('');
										document.getElementById("modalTableBody").innerHTML = tableRows;

										// 삭제 버튼에 클릭 이벤트 추가
										var deleteButtons = document.querySelectorAll(".delete-post-btn");
										deleteButtons.forEach(function (button) {
											button.addEventListener("click", function () {
												var rNo = button.getAttribute("data-rno");
												deletePost(rNo);
											});
										});
									}
									modal.style.display = "block";
								})
								.catch(error => {
									console.error('Error fetching posts:', error);
									document.getElementById("modalTableBody").innerHTML = '<tr><td colspan="6">데이터를 가져오는 중 오류가 발생했습니다.</td></tr>';
									modal.style.display = "block";
								});
						}
					});
				});

				span.onclick = function () {
					modal.style.display = "none";
				}

				window.onclick = function (event) {
					if (event.target === modal) {
						modal.style.display = "none";
					}
				}
			});

			// 게시글 삭제 요청 함수
			function deletePost(rNo) {
				fetch('/deletePost?rNo=' + rNo, {
					method: 'DELETE'
				})
					.then(response => {
						if (response.ok) {
							alert('게시글이 삭제되었습니다.');
							location.reload(); // 페이지 새로고침으로 목록 갱신
						} else {
							alert('게시글 삭제에 실패했습니다.');
						}
					})
					.catch(error => {
						console.error('Error deleting post:', error);
						alert('게시글 삭제 중 오류가 발생했습니다.');
					});
			}

		</script>
</body>

</html>