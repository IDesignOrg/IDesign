<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Review List</title>
	<link rel="stylesheet" href="/css/review.css" />
	<link rel="stylesheet" href="/css/header.css" />
	<link rel="stylesheet" href="/css/reset.css" />
	<link rel="stylesheet" href="/css/review/reviewlist.css" />

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
	<th:block th:include="~{fragments/header.html::header}"></th:block>
	<div class="container">
		<h1>리뷰</h1>
		<div class="review-grid">
			<div class="review-card" th:each="review : ${reviews}" th:data-rno="${review.RNo}">
				<img th:src="${review.RMainPhoto}" alt="Review Image">
				<div class="review-content">
					<div class="review-title" th:text="${review.RTitle}"></div>
					<div class="review-text" th:text="${#strings.abbreviate(review.RContent, 100)}"></div>
				</div>
				<div class="review-footer">
					<span th:text="${review.user.UId}">User ID</span>
					<span class="written-time"
						th:text="${#temporals.format(review.RWrittenTime, 'yyyy-MM-dd HH:mm')}"></span>
				</div>
			</div>
		</div>
		<a href="/review_write">리뷰 작성하기</a>
		<!-- 모달 -->
		<div id="reviewModal" class="modal">
			<div class="modal-content">
				<!-- 슬라이드 쇼 컨테이너 -->
				<div class="slider">
					<div class="slides" id="photoContainer">
						<!-- 슬라이드 내용이 JavaScript로 동적으로 추가됨 -->
					</div>
					<!-- 이전 및 다음 버튼 -->
					<button class="prev" onclick="changeSlide(-1)">&#10094;</button>
					<button class="next" onclick="changeSlide(1)">&#10095;</button>
				</div>

				<!-- 오른쪽 정보 패널 -->
				<div class="info-panel">
					<div class="info-header">
						<h2 id="modalTitle"></h2>
						<div class="info-subheader">
							<span id="modalUserId"></span>
							<span id="modalWrittenTime"></span>
						</div>
					</div>
					<div class="info-content">
						<p id="modalContent"></p>

						<!-- 댓글 섹션 -->
						<div class="comment-section" id="commentSection">
							<!-- 댓글이 JavaScript로 동적으로 추가됨 -->
						</div>
					</div>
					<div class="info-footer">
						<p>조회수: <span id="modalViews"></span></p>
						<!-- 댓글 작성 폼 -->
						<div class="comment-form" th:if="${session.UId != null}">
							<textarea id="commentInput" placeholder="댓글을 입력하세요..."></textarea>
							<button id="submitComment" onclick="submitComment()">댓글 작성</button>
						</div>
					</div>
					<span class="close">&times;</span>
				</div>
			</div>
		</div>
		<div class="pagination">
			<a th:href="@{/auth/evaluation(page=${currentPage - 1})}" th:if="${currentPage > 0}">&laquo; 이전</a>
			<span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
				<a th:href="@{/auth/evaluation(page=${i})}" th:classappend="${i == currentPage} ? 'active'"
					th:text="${i + 1}">1</a>
			</span>
			<a th:href="@{/auth/evaluation(page=${currentPage + 1})}" th:if="${currentPage < totalPages - 1}">다음
				&raquo;</a>
		</div>
	</div>

	<script>
		let currentSlideIndex = 0;
		let currentReviewId = null;

		function showSlides(index) {
			const slides = document.querySelectorAll(".slides img");
			if (index >= slides.length) {
				currentSlideIndex = 0;
			} else if (index < 0) {
				currentSlideIndex = slides.length - 1;
			} else {
				currentSlideIndex = index;
			}
			slides.forEach((slide, i) => {
				slide.style.transform = `translateX(-${currentSlideIndex * 100}%)`;
			});
		}

		function changeSlide(n) {
			showSlides(currentSlideIndex + n);
		}

		function submitComment() {
		    const commentInput = document.getElementById("commentInput");
		    const commentText = commentInput.value.trim();

		    if (!commentText) {
		        alert("댓글을 입력하세요.");
		        return;
		    }

		    console.log("currentReviewId:", currentReviewId);

		    $.ajax({
		        url: `/api/review/comment`,
		        type: "POST",
		        contentType: "application/json", 
		        data: JSON.stringify({
					reviewId: currentReviewId,
		            comment: commentText  
		        }),
				success: function(response) {
					const newComment = response.data;
				    // 서버에서 받은 데이터를 콘솔에 출력하여 확인
				    console.log("서버 응답 데이터:", newComment);

				    const commentSection = document.getElementById("commentSection");
				    const commentDiv = document.createElement("div");
				    commentDiv.classList.add("comment");

				    // 데이터를 HTML에 추가
				    commentDiv.innerHTML = `
				        <img src="${newComment.userProfile || 'https://storage.googleapis.com/idesign_dev/static/static_static_blank-profile-picture-973460_640.png'}" alt="User profile">
				        <div class="comment-text">
				            <span class="username">${newComment.userName || 'Unknown'}</span>
				            ${newComment.rcomment || 'No comment available'}
				        </div>
				    `;
				    
				    // 댓글 섹션에 새 댓글 추가
				    commentSection.appendChild(commentDiv);

				    // 입력 필드 비우기
				    document.getElementById("commentInput").value = "";
				}
,
		        error: function(xhr, status, error) {
		            alert("Error: " + xhr);
					console.log("xhr" + xhr)
		        }
				
		    });
		}


		document.addEventListener("DOMContentLoaded", function () {
			const modal = document.getElementById("reviewModal");
			const closeModal = document.getElementsByClassName("close")[0];

			document.querySelectorAll(".review-card").forEach(card => {
				card.addEventListener("click", function () {
					currentReviewId = card.getAttribute("data-rno");

					fetch(`/auth/evaluation/${currentReviewId}`)  // 리뷰 데이터와 댓글 데이터 동시에 가져옴
						//.then(response => response.json())
						.then(response => response.text()) 
						.then(text => {
						    console.log(text);  // JSON 텍스트 출력
						    return JSON.parse(text);  // 이후에 파싱 시도
						  })
						.then(reviewData => {
							// 리뷰 데이터 처리
							document.getElementById("modalTitle").textContent = reviewData.rtitle || 'N/A';
							document.getElementById("modalUserId").textContent = reviewData.userId || 'Unknown';
							document.getElementById("modalWrittenTime").textContent = reviewData.rwrittenTime || 'N/A';
							document.getElementById("modalContent").textContent = reviewData.rcontent || 'N/A';
							document.getElementById("modalViews").textContent = reviewData.rviews || '0';

							// 사진 처리 코드
							const photoContainer = document.getElementById("photoContainer");
							photoContainer.innerHTML = '';
							reviewData.reviewPhotos.forEach(photoUrl => {
								const img = document.createElement("img");
								img.src = photoUrl;
								img.alt = "Review Photo";
								photoContainer.appendChild(img);
							});

							// 댓글 데이터 처리
							const commentSection = document.getElementById("commentSection");
							commentSection.innerHTML = ''; // 기존 댓글 삭제

							if (reviewData.comments.length > 0) {
								reviewData.comments.forEach(comment => {
									const commentDiv = document.createElement("div");
									commentDiv.classList.add("comment");

									commentDiv.innerHTML = `
                                <img src="${comment.userProfile || '/path/to/default/profile.jpg'}" alt="User profile">
                                <div class="comment-text">
                                    <span class="username">${comment.userName || 'Unknown'}</span>
                                    ${comment.rcomment || 'No comment available'}
                                </div>
                            `;
									commentSection.appendChild(commentDiv);
								});
								commentSection.style.display = 'block'; // 댓글 섹션 보이기
							} else {
								commentSection.style.display = 'none'; // 댓글이 없으면 숨기기
							}

							// 모달 열기
							modal.style.display = "block";
							showSlides(0);  // 첫 슬라이드 표시
						})
						.catch(error => console.error('Error:', error));
				});
			});

			// 모달 닫기 기능
			closeModal.onclick = function () {
				modal.style.display = "none";
			};

			// 모달 외부 클릭 시 닫기
			window.onclick = function (event) {
				if (event.target === modal) {
					modal.style.display = "none";
				}
			};
		});

	</script>
</body>

</html>